<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Detail | LCE Project Hub</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* â”€â”€ Concurrence styles â”€â”€ */
    .concurrence-card { background:#fff; border-radius:var(--radius-lg); border:1px solid var(--border); padding:20px; margin-bottom:16px; box-shadow:var(--shadow); border-left:4px solid var(--purple); }
    .concurrence-card.sent { border-left-color:var(--green); }
    .concurrence-title { font-size:15px; font-weight:600; color:var(--purple-dark); margin-bottom:4px; }
    .concurrence-desc  { font-size:12px; color:var(--text-muted); margin-bottom:12px; }
    .reviewer-row { display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--bg); border-radius:var(--radius); margin-bottom:6px; border:1px solid var(--border); }
    .reviewer-row.signed   { background:var(--green-pale); border-color:#C8E6C9; }
    .reviewer-row .rv-name { flex:1; font-size:13px; font-weight:500; }
    .reviewer-row .rv-desig { font-size:11px; color:var(--text-muted); }
    .reviewer-row .rv-date  { font-size:11px; color:var(--green-dark); }
    .hod-signoff { margin-top:14px; padding:14px; background:#F3EEF9; border-radius:var(--radius); border:1px solid var(--border); }
    .sent-banner { background:var(--green-pale); border:1px solid #C8E6C9; border-radius:var(--radius); padding:10px 14px; font-size:13px; color:var(--green-dark); font-weight:600; display:flex; align-items:center; gap:8px; margin-top:10px; }
    /* â”€â”€ Task tracker â”€â”€ */
    .badge-acceptance { background:#F3EEF9; color:var(--purple); }
    .with-badge { font-size:11px; background:var(--purple-pale); color:var(--purple); padding:2px 8px; border-radius:4px; font-weight:500; }
    /* â”€â”€ PDF badge â”€â”€ */
    .pdf-badge { font-size:10px; background:#E3F2FD; color:#1565C0; padding:2px 7px; border-radius:4px; font-weight:500; display:inline-flex; align-items:center; gap:3px; text-decoration:none; }
    .pdf-badge:hover { background:#BBDEFB; }
    /* â”€â”€ Completion data â”€â”€ */
    .completion-chip { font-size:10px; background:#E8F5E9; color:#2E7D32; padding:2px 7px; border-radius:4px; font-weight:500; }
    /* â”€â”€ Notes â”€â”€ */
    .note-card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px 14px; margin-bottom:10px; }
    .note-meta { font-size:11px; color:var(--text-muted); margin-bottom:5px; }
    .note-text { font-size:13px; white-space:pre-wrap; }
    /* â”€â”€ Subproject card â”€â”€ */
    .sub-card { background:#fff; border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px 16px; margin-bottom:10px; cursor:pointer; transition:box-shadow 0.15s; border-left:3px solid var(--purple-light); }
    .sub-card:hover { box-shadow:0 4px 12px rgba(102,51,170,0.12); }
    /* â”€â”€ Assignee pills â”€â”€ */
    .assignee-pill { display:inline-flex; align-items:center; gap:4px; background:var(--purple-pale); color:var(--purple-dark); padding:2px 8px; border-radius:12px; font-size:11px; font-weight:500; margin:1px 2px; }
    /* â”€â”€ Multi-select checkboxes â”€â”€ */
    .assignee-check-list { max-height:180px; overflow-y:auto; border:1.5px solid var(--border); border-radius:var(--radius); padding:8px; }
    .assignee-check-item { display:flex; align-items:center; gap:8px; padding:6px; border-radius:6px; cursor:pointer; transition:background 0.1s; }
    .assignee-check-item:hover { background:#f5f3fa; }
    .assignee-check-item label { cursor:pointer; flex:1; }
    /* â”€â”€ PDF upload area â”€â”€ */
    .pdf-upload-area { border:2px dashed var(--border); border-radius:var(--radius); padding:16px; text-align:center; cursor:pointer; transition:border-color 0.15s; }
    .pdf-upload-area:hover { border-color:var(--purple); }
    .pdf-upload-area.has-file { border-color:var(--green); background:var(--green-pale); }
  </style>
</head>
<body>
<div class="app-layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="LCE LOGO.png" alt="LCE">
      <div class="dept-name">Civil &amp; Structural Â· Project Hub</div>
    </div>
    <div class="sidebar-user">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-name"  id="userName">Loading...</div>
      <div class="user-desig" id="userDesig"></div>
    </div>
    <nav class="sidebar-nav">
      <a class="nav-item" href="dashboard.html"><span class="nav-icon">ğŸ </span><span>Dashboard</span></a>
      <a class="nav-item" href="kanban.html"><span class="nav-icon">ğŸ“Š</span><span>My Board</span></a>
    </nav>
    <div class="sidebar-footer">
      <button class="nav-item" onclick="APP.logout()"><span class="nav-icon">ğŸšª</span><span>Logout</span></button>
    </div>
  </aside>

  <!-- Main -->
  <div class="main-content">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px;">
        <a href="dashboard.html" style="text-decoration:none;color:var(--text-muted);font-size:13px;">â† Dashboard</a>
        <span style="color:var(--border);">/</span>
        <span class="topbar-title" id="topbarTitle">Project</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button id="addTaskBtn"    class="btn btn-green  btn-sm" onclick="openNewTaskModal()"    style="display:none;">+ Add Task</button>
        <button id="editProjectBtn" class="btn btn-ghost btn-sm" onclick="openEditProjectModal()" style="display:none;">âœï¸ Edit</button>
      </div>
    </div>

    <div class="page-content">

      <!-- Project header -->
      <div class="project-detail-header" id="projectHeader">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;">
            <div id="projectTitle" class="project-detail-title">Loading...</div>
            <div id="projectDesc"  class="project-detail-desc"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;" id="projectBadges"></div>
        </div>
        <div class="project-detail-meta" id="projectMeta"></div>
      </div>

      <!-- Task stats -->
      <div class="stats-grid" id="taskStats" style="margin-bottom:20px;"></div>

      <!-- Tabs -->
      <div class="tabs" id="tabBar">
        <button class="tab-btn active" onclick="switchTab('tasks',this)">ğŸ“‹ Tasks</button>
        <button class="tab-btn" id="concurrenceTabBtn" onclick="switchTab('concurrence',this)" style="display:none;">ğŸ” Concurrence</button>
        <button class="tab-btn" id="subprojectsTabBtn" onclick="switchTab('subprojects',this)" style="display:none;">ğŸ“ Subprojects</button>
        <button class="tab-btn" onclick="switchTab('notes',this)">ğŸ“ Notes</button>
      </div>

      <!-- â”€â”€ Tasks Tab â”€â”€ -->
      <div id="tabTasks">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
          <div id="l1TrackInfo" style="display:none;font-size:12px;color:var(--purple);font-weight:500;">ğŸ‘ Tracking all tasks across team</div>
          <select id="statusFilter" class="form-control" style="width:auto;font-size:13px;" onchange="renderTasks()">
            <option value="">All Status</option>
            <option value="To Do">To Do</option>
            <option value="In Progress">In Progress</option>
            <option value="Acceptance">Acceptance</option>
            <option value="Done">Done</option>
          </select>
        </div>
        <div id="taskList" class="task-list"></div>
      </div>

      <!-- â”€â”€ Concurrence Tab â”€â”€ -->
      <div id="tabConcurrence" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h3 style="font-size:16px;color:var(--purple-dark);">Concurrence Sign-off</h3>
            <p style="font-size:12px;color:var(--text-muted);margin-top:3px;">L1 creates concurrences. HOD gives final sign-off.</p>
          </div>
          <button id="newConcurrenceBtn" class="btn btn-primary btn-sm" onclick="openNewConcurrenceModal()" style="display:none;">+ New Concurrence</button>
        </div>
        <div id="concurrenceList"></div>
      </div>

      <!-- â”€â”€ Subprojects Tab â”€â”€ -->
      <div id="tabSubprojects" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h3 style="font-size:16px;color:var(--purple-dark);">Subprojects</h3>
            <p style="font-size:12px;color:var(--text-muted);margin-top:3px;">Break this project into smaller sub-deliverables.</p>
          </div>
          <button id="newSubprojectBtn" class="btn btn-green btn-sm" onclick="openNewSubprojectModal()" style="display:none;">+ New Subproject</button>
        </div>
        <div id="subprojectList"></div>
      </div>

      <!-- â”€â”€ Notes Tab â”€â”€ -->
      <div id="tabNotes" style="display:none;">
        <div style="margin-bottom:16px;">
          <textarea id="newNoteText" class="form-control" rows="3" placeholder="Add a note, comment or update about this project..."></textarea>
          <button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="addNote()">Add Note</button>
        </div>
        <div id="notesList"></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â”€â”€ Task Modal â”€â”€ -->
<div class="modal-overlay" id="taskModal">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <h3 id="taskModalTitle">Add Task</h3>
      <button class="modal-close" onclick="closeTaskModal()">Ã—</button>
    </div>
    <div id="taskModalAlert" class="alert alert-error"></div>
    <div class="form-group">
      <label class="form-label">Task Title *</label>
      <input type="text" id="tTitle" class="form-control" placeholder="e.g. Prepare RCC Column Design">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="tDesc" class="form-control" rows="2" placeholder="Details..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Priority *</label>
        <select id="tPriority" class="form-control">
          <option value="High">ğŸ”´ High</option>
          <option value="Medium" selected>ğŸŸ¡ Medium</option>
          <option value="Low">ğŸŸ¢ Low</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Due Date</label>
        <input type="date" id="tDueDate" class="form-control">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Assign To (select one or more)</label>
      <div style="margin-bottom:6px;">
        <label style="font-size:12px;color:var(--purple);cursor:pointer;">
          <input type="checkbox" id="tSelfAssign" style="margin-right:4px;" onchange="toggleSelfAssign()"> Assign to myself
        </label>
      </div>
      <div class="assignee-check-list" id="tAssigneeList"></div>
    </div>
    <input type="hidden" id="editTaskId">
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Task Detail / Edit + PDF + Completion Modal â”€â”€ -->
<div class="modal-overlay" id="taskDetailModal">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <h3 id="tdTitle">Task Detail</h3>
      <button class="modal-close" onclick="closeTaskDetailModal()">Ã—</button>
    </div>
    <div id="tdBody"></div>
    <!-- PDF upload section (shown to assignees) -->
    <div id="tdPdfSection" style="display:none;margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
      <label class="form-label">Upload Deliverable PDF</label>
      <div class="pdf-upload-area" id="pdfDropArea" onclick="document.getElementById('pdfFileInput').click()">
        <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="onPdfSelected(event)">
        <div id="pdfUploadText">ğŸ“ Click to attach PDF (max 1 MB)</div>
      </div>
      <div id="pdfExistingLink" style="margin-top:6px;"></div>
    </div>
    <!-- Completion data (shown when moving to Done) -->
    <div id="tdCompletionSection" style="display:none;margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
      <label class="form-label">Completion Details *</label>
      <div class="form-row" style="margin-bottom:8px;">
        <div class="form-group">
          <label class="form-label" style="font-size:11px;">Drawing Type</label>
          <select id="cdType" class="form-control" onchange="toggleCompletionFields()">
            <option value="">â€” Select â€”</option>
            <option value="civil">Civil Design</option>
            <option value="structural">Structural Design</option>
          </select>
        </div>
      </div>
      <div id="cdCivilRow" style="display:none;" class="form-group">
        <label class="form-label" style="font-size:11px;">RCC Details</label>
        <input type="text" id="cdRcc" class="form-control" placeholder="e.g. M25 grade, 120 MT">
      </div>
      <div id="cdStructuralRow" style="display:none;" class="form-group">
        <label class="form-label" style="font-size:11px;">Tonnage (MT)</label>
        <input type="text" id="cdTonnage" class="form-control" placeholder="e.g. 45.5 MT">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskDetailModal()">Close</button>
      <button id="tdSaveBtn" class="btn btn-primary" onclick="saveTaskDetail()" style="display:none;">Save Changes</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Project Modal â”€â”€ -->
<div class="modal-overlay" id="editProjectModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Edit Project</h3>
      <button class="modal-close" onclick="closeEditProjectModal()">Ã—</button>
    </div>
    <div id="editProjAlert" class="alert alert-error"></div>
    <div class="form-group">
      <label class="form-label">Project Title *</label>
      <input type="text" id="epTitle" class="form-control">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="epDesc" class="form-control" rows="3"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select id="epPriority" class="form-control">
          <option value="High">ğŸ”´ High</option>
          <option value="Medium">ğŸŸ¡ Medium</option>
          <option value="Low">ğŸŸ¢ Low</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select id="epStatus" class="form-control">
          <option value="Not Started">Not Started</option>
          <option value="In Progress">In Progress</option>
          <option value="Completed">Completed</option>
          <option value="On Hold">On Hold</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Due Date</label>
      <input type="date" id="epDueDate" class="form-control">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEditProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditProject()">Save Changes</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Delete Task confirm â”€â”€ -->
<div class="modal-overlay" id="deleteTaskModal">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <h3>Delete Task</h3>
      <button class="modal-close" onclick="closeDeleteTaskModal()">Ã—</button>
    </div>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:8px;">Delete "<strong id="deleteTaskName"></strong>"? This cannot be undone.</p>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDeleteTaskModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDeleteTask()">Delete</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Concurrence Modal â”€â”€ -->
<div class="modal-overlay" id="concurrenceModal">
  <div class="modal" style="max-width:580px;">
    <div class="modal-header">
      <h3>New Concurrence</h3>
      <button class="modal-close" onclick="closeConcurrenceModal()">Ã—</button>
    </div>
    <div id="clAlert" class="alert alert-error"></div>
    <div class="form-group">
      <label class="form-label">Drawing / Document Title *</label>
      <input type="text" id="clTitle" class="form-control" placeholder="e.g. Foundation Plan â€” Block A">
    </div>
    <div class="form-group">
      <label class="form-label">Description / Notes</label>
      <textarea id="clDesc" class="form-control" rows="2" placeholder="Optional notes..."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Reviewers who must sign *</label>
      <div style="display:flex;gap:8px;margin-bottom:6px;">
        <button type="button" class="btn btn-ghost btn-sm" onclick="autoPopulateReviewers()">âš¡ Auto-add task participants</button>
      </div>
      <div id="reviewerCheckboxes" class="assignee-check-list" style="max-height:200px;"></div>
      <div class="form-hint">Auto-add pulls in everyone who has tasks in this project.</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeConcurrenceModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveConcurrence()">Create Concurrence</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Subproject Modal â”€â”€ -->
<div class="modal-overlay" id="subprojectModal">
  <div class="modal">
    <div class="modal-header">
      <h3>New Subproject</h3>
      <button class="modal-close" onclick="closeSubprojectModal()">Ã—</button>
    </div>
    <div id="spAlert" class="alert alert-error"></div>
    <div class="form-group">
      <label class="form-label">Subproject Title *</label>
      <input type="text" id="spTitle" class="form-control" placeholder="e.g. Block A Foundation">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="spDesc" class="form-control" rows="2"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select id="spPriority" class="form-control">
          <option value="High">ğŸ”´ High</option>
          <option value="Medium" selected>ğŸŸ¡ Medium</option>
          <option value="Low">ğŸŸ¢ Low</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Due Date</label>
        <input type="date" id="spDueDate" class="form-control">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeSubprojectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSubproject()">Create Subproject</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script>
  let currentUser      = null;
  let projectId        = null;
  let project          = null;
  let currentTab       = 'tasks';
  let deleteTaskTarget = null;
  let taskDetailId     = null;
  let pendingPdfData   = null;
  let pendingPdfName   = null;

  function getProjectId() { return new URLSearchParams(window.location.search).get('id'); }

  function init() {
    currentUser = APP.requireAuth();
    if (!currentUser) return;
    projectId = getProjectId();
    project   = APP.getProjectById(projectId);
    if (!project) { window.location.href = 'dashboard.html'; return; }

    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('userName').textContent   = currentUser.name;
    document.getElementById('userDesig').textContent  = currentUser.designation;
    document.getElementById('topbarTitle').textContent = project.title;

    if (APP.canCreateTasks(currentUser))    document.getElementById('addTaskBtn').style.display    = 'flex';
    if (APP.canCreateProjects(currentUser)) document.getElementById('editProjectBtn').style.display = 'flex';

    // Concurrence tab: visible to everyone; Create button for L1+ and admin
    document.getElementById('concurrenceTabBtn').style.display = 'inline-flex';
    if (APP.canCreateConcurrence(currentUser)) {
      document.getElementById('newConcurrenceBtn').style.display = 'flex';
    }

    // Subprojects tab for L1+ and admin
    if (APP.canCreateSubprojects(currentUser)) {
      document.getElementById('subprojectsTabBtn').style.display = 'inline-flex';
      document.getElementById('newSubprojectBtn').style.display  = 'flex';
    }

    // L1 / admin tracking banner
    if (currentUser.level === 'L1' || APP.isAdmin(currentUser)) {
      document.getElementById('l1TrackInfo').style.display = 'block';
    }

    renderProjectHeader();
    renderTaskStats();
    renderTasks();
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab, btn) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tabTasks').style.display        = tab === 'tasks'       ? 'block' : 'none';
    document.getElementById('tabConcurrence').style.display  = tab === 'concurrence' ? 'block' : 'none';
    document.getElementById('tabSubprojects').style.display  = tab === 'subprojects' ? 'block' : 'none';
    document.getElementById('tabNotes').style.display        = tab === 'notes'       ? 'block' : 'none';
    document.getElementById('addTaskBtn').style.display = (tab === 'tasks' && APP.canCreateTasks(currentUser)) ? 'flex' : 'none';
    if (tab === 'concurrence') renderConcurrences();
    if (tab === 'subprojects') renderSubprojects();
    if (tab === 'notes')       renderNotes();
  }

  // â”€â”€ Project Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProjectHeader() {
    const ph = document.getElementById('projectHeader');
    ph.className = `project-detail-header priority-${project.priority}`;
    document.getElementById('projectTitle').textContent = project.title;
    document.getElementById('projectDesc').textContent  = project.description || '';
    const overdue = project.dueDate && new Date(project.dueDate) < new Date() && project.status !== 'Completed';
    const statusClass = (project.status || 'Not Started').replace(/\s+/g,'').toLowerCase();
    document.getElementById('projectBadges').innerHTML = `
      <span class="badge badge-${(project.priority||'medium').toLowerCase()}">${project.priority}</span>
      <span class="badge badge-${statusClass}">${project.status || 'Not Started'}</span>
      ${overdue ? '<span class="badge" style="background:#FDECEA;color:var(--danger);">Overdue</span>' : ''}
    `;
    const assigneeNames = APP.getProjectAssigneeIds(project).map(id => APP.getUserName(id)).filter(n => n !== 'â€”');
    document.getElementById('projectMeta').innerHTML = `
      <div class="meta-item"><span class="meta-label">Created</span><span class="meta-value">${APP.formatDate(project.createdAt)}</span></div>
      <div class="meta-item"><span class="meta-label">Due Date</span><span class="meta-value" style="${overdue?'color:var(--danger);font-weight:600;':''}">${APP.formatDate(project.dueDate)}</span></div>
      <div class="meta-item"><span class="meta-label">Assignee(s)</span><span class="meta-value">${assigneeNames.join(', ') || 'â€”'}</span></div>
      <div class="meta-item"><span class="meta-label">Created By</span><span class="meta-value">${APP.getUserName(project.createdBy)}</span></div>
    `;
  }

  // â”€â”€ Task Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTaskStats() {
    const tasks = APP.getProjectTasks(projectId, currentUser);
    const todo  = tasks.filter(t => t.status === 'To Do').length;
    const inp   = tasks.filter(t => t.status === 'In Progress').length;
    const acc   = tasks.filter(t => t.status === 'Acceptance').length;
    const done  = tasks.filter(t => t.status === 'Done').length;
    const pct   = tasks.length ? Math.round((done / tasks.length) * 100) : 0;
    document.getElementById('taskStats').innerHTML = `
      <div class="stat-card"><div class="stat-value">${tasks.length}</div><div class="stat-label">Total Tasks</div></div>
      <div class="stat-card" style="border-left-color:#aaa;"><div class="stat-value" style="color:#555;">${todo}</div><div class="stat-label">To Do</div></div>
      <div class="stat-card" style="border-left-color:var(--info);"><div class="stat-value" style="color:var(--info);">${inp}</div><div class="stat-label">In Progress</div></div>
      <div class="stat-card" style="border-left-color:var(--purple-light);"><div class="stat-value" style="color:var(--purple);">${acc}</div><div class="stat-label">Acceptance</div></div>
      <div class="stat-card green"><div class="stat-value" style="color:var(--success);">${done}</div><div class="stat-label">Done</div></div>
      <div class="stat-card" style="border-left-color:var(--green);"><div class="stat-value" style="color:var(--green-dark);font-size:22px;">${pct}%</div><div class="stat-label">Complete</div></div>
    `;
  }

  // â”€â”€ Task List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTasks() {
    const filterStatus  = document.getElementById('statusFilter').value;
    let tasks = APP.getProjectTasks(projectId, currentUser);
    if (filterStatus) tasks = tasks.filter(t => t.status === filterStatus);

    const list        = document.getElementById('taskList');
    const canDelete   = APP.canCreateProjects(currentUser);
    const canEdit     = APP.canCreateTasks(currentUser);
    const isL1orAdmin = currentUser.level === 'L1' || APP.isAdmin(currentUser);

    if (tasks.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ…</div><h3>${filterStatus ? 'No tasks with this status' : 'No tasks yet'}</h3><p>${canEdit ? 'Click "+ Add Task" to create the first task.' : 'No tasks assigned to you yet.'}</p></div>`;
      return;
    }

    list.innerHTML = tasks.map(t => {
      const overdue      = t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'Done';
      const statusClass  = t.status.replace(/\s+/g,'').toLowerCase();
      const assigneeNames = APP.getTaskAssigneeNames(t);
      const isConcTask   = t.isConcurrenceTask;
      const hasPdf       = !!t.pdfData;
      const completionChip = t.completionData
        ? (t.completionData.type === 'civil'
            ? `<span class="completion-chip">RCC: ${APP.escapeHtml(t.completionData.rcc||'â€”')}</span>`
            : `<span class="completion-chip">Tonnage: ${APP.escapeHtml(t.completionData.tonnage||'â€”')} MT</span>`)
        : '';
      return `
        <div class="task-item priority-${t.priority}" onclick="openTaskDetail('${t.id}')" style="cursor:pointer;">
          <div class="task-info">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <span class="task-title">${APP.escapeHtml(t.title)}</span>
              ${isConcTask ? '<span style="font-size:10px;background:#F3EEF9;color:var(--purple);padding:2px 6px;border-radius:4px;">ğŸ” Concurrence</span>' : ''}
              ${isL1orAdmin ? `<span class="with-badge">ğŸ“Œ ${assigneeNames.join(', ')}</span>` : ''}
              ${hasPdf ? `<a class="pdf-badge" href="${t.pdfData}" download="${t.pdfName||'delivery.pdf'}" onclick="event.stopPropagation()">ğŸ“„ PDF</a>` : ''}
              ${completionChip}
            </div>
            ${t.description ? `<div style="font-size:12px;color:var(--text-muted);margin-top:3px;">${APP.escapeHtml(t.description)}</div>` : ''}
            <div class="task-meta">
              <span class="badge badge-${statusClass}">${t.status}</span>
              <span class="badge badge-${(t.priority||'medium').toLowerCase()}">${t.priority}</span>
              ${t.dueDate ? `<span style="${overdue?'color:var(--danger);font-weight:600;':''}">ğŸ“… ${APP.formatDate(t.dueDate)}${overdue?' âš ï¸':''}</span>` : ''}
              <span style="color:var(--text-muted);">By: ${APP.getUserName(t.createdBy)}</span>
            </div>
          </div>
          <div class="task-actions" onclick="event.stopPropagation()">
            <select class="status-select" onchange="handleStatusChange('${t.id}', this.value, this)">
              <option value="To Do"       ${t.status==='To Do'?'selected':''}>To Do</option>
              <option value="In Progress" ${t.status==='In Progress'?'selected':''}>In Progress</option>
              <option value="Acceptance"  ${t.status==='Acceptance'?'selected':''}>Acceptance</option>
              <option value="Done"        ${t.status==='Done'?'selected':''}>Done</option>
            </select>
            ${canEdit   ? `<button class="btn btn-ghost btn-sm" onclick="openEditTask('${t.id}')" title="Edit">âœï¸</button>` : ''}
            ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="openDeleteTask('${t.id}','${APP.escapeHtml(t.title)}')" title="Delete">ğŸ—‘ï¸</button>` : ''}
          </div>
        </div>`;
    }).join('');
  }

  // â”€â”€ Status change with Done-completion prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleStatusChange(taskId, newStatus, selectEl) {
    if (newStatus !== 'Done') {
      APP.updateTask(taskId, { status: newStatus });
      renderTaskStats(); renderTasks();
      return;
    }
    // Moving to Done: check if current user is an assignee
    const task = APP.getTaskById(taskId);
    const isAssignee = APP.isTaskAssignedTo(task, currentUser.id);
    if (isAssignee) {
      // Open detail modal with completion section
      openTaskDetail(taskId, true);
    } else {
      APP.updateTask(taskId, { status: 'Done' });
      renderTaskStats(); renderTasks();
    }
  }

  // â”€â”€ Task Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openTaskDetail(taskId, requireCompletion) {
    const t = APP.getTaskById(taskId);
    if (!t) return;
    taskDetailId = taskId;
    pendingPdfData = null; pendingPdfName = null;

    document.getElementById('tdTitle').textContent = t.title;

    const assigneeNames = APP.getTaskAssigneeNames(t);
    const isAssignee    = APP.isTaskAssignedTo(t, currentUser.id);
    const canEdit       = APP.canCreateTasks(currentUser) || isAssignee;
    const proj          = APP.getProjectById(t.projectId);

    document.getElementById('tdBody').innerHTML = `
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${t.description ? `<p style="font-size:13px;color:var(--text);">${APP.escapeHtml(t.description)}</p>` : ''}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:4px 0;">
          <span class="badge badge-${t.status.replace(/\s+/g,'').toLowerCase()}">${t.status}</span>
          <span class="badge badge-${(t.priority||'medium').toLowerCase()}">${t.priority}</span>
        </div>
        <div style="font-size:12px;color:var(--text-muted);">
          <div>ğŸ“ Project: <strong>${proj ? APP.escapeHtml(proj.title) : 'â€”'}</strong></div>
          <div>ğŸ‘¤ Assignee(s): <strong>${assigneeNames.join(', ')}</strong></div>
          ${t.dueDate ? `<div>ğŸ“… Due: <strong>${APP.formatDate(t.dueDate)}</strong></div>` : ''}
          <div>ğŸ• Created: ${APP.formatDateTime(t.createdAt)} by ${APP.getUserName(t.createdBy)}</div>
        </div>
        ${t.completionData ? `
          <div style="margin-top:8px;padding:10px;background:var(--green-pale);border-radius:var(--radius);">
            <div style="font-size:12px;font-weight:600;color:var(--green-dark);margin-bottom:4px;">Completion Data</div>
            <div style="font-size:12px;">Type: <strong>${t.completionData.type === 'civil' ? 'Civil Design' : 'Structural Design'}</strong></div>
            ${t.completionData.type === 'civil'       ? `<div style="font-size:12px;">RCC: <strong>${APP.escapeHtml(t.completionData.rcc||'â€”')}</strong></div>` : ''}
            ${t.completionData.type === 'structural'  ? `<div style="font-size:12px;">Tonnage: <strong>${APP.escapeHtml(t.completionData.tonnage||'â€”')} MT</strong></div>` : ''}
          </div>` : ''}
        ${t.pdfData ? `<a class="pdf-badge" style="margin-top:6px;" href="${t.pdfData}" download="${t.pdfName||'delivery.pdf'}">ğŸ“„ Download PDF: ${APP.escapeHtml(t.pdfName||'delivery.pdf')}</a>` : ''}
        ${canEdit ? `
          <div style="margin-top:10px;border-top:1px solid var(--border);padding-top:10px;">
            <label class="form-label" style="font-size:11px;">Update Status</label>
            <select id="tdStatusSel" class="form-control" style="width:auto;">
              <option value="To Do"       ${t.status==='To Do'?'selected':''}>To Do</option>
              <option value="In Progress" ${t.status==='In Progress'?'selected':''}>In Progress</option>
              <option value="Acceptance"  ${t.status==='Acceptance'?'selected':''}>Acceptance</option>
              <option value="Done"        ${t.status==='Done'?'selected':''}>Done</option>
            </select>
          </div>` : ''}
      </div>`;

    // PDF upload section for assignees
    const pdfSection = document.getElementById('tdPdfSection');
    if (isAssignee) {
      pdfSection.style.display = 'block';
      document.getElementById('pdfUploadText').textContent = t.pdfData ? `âœ… PDF attached: ${t.pdfName||'file.pdf'} â€” click to replace` : 'ğŸ“ Click to attach PDF (max 1 MB)';
      document.getElementById('pdfDropArea').className = t.pdfData ? 'pdf-upload-area has-file' : 'pdf-upload-area';
    } else {
      pdfSection.style.display = 'none';
    }

    // Completion section
    const compSection = document.getElementById('tdCompletionSection');
    if (isAssignee && !t.completionData) {
      compSection.style.display = requireCompletion ? 'block' : 'block';
      document.getElementById('cdType').value    = '';
      document.getElementById('cdRcc').value     = '';
      document.getElementById('cdTonnage').value = '';
      document.getElementById('cdCivilRow').style.display      = 'none';
      document.getElementById('cdStructuralRow').style.display = 'none';
    } else {
      compSection.style.display = 'none';
    }

    document.getElementById('tdSaveBtn').style.display = (isAssignee || canEdit) ? 'inline-flex' : 'none';
    document.getElementById('taskDetailModal').classList.add('open');
  }

  function toggleCompletionFields() {
    const type = document.getElementById('cdType').value;
    document.getElementById('cdCivilRow').style.display      = type === 'civil'      ? 'block' : 'none';
    document.getElementById('cdStructuralRow').style.display = type === 'structural' ? 'block' : 'none';
  }

  function onPdfSelected(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 1024 * 1024) {
      alert('PDF file must be under 1 MB.');
      event.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingPdfData = e.target.result;
      pendingPdfName = file.name;
      document.getElementById('pdfUploadText').textContent = `âœ… ${file.name} ready to save`;
      document.getElementById('pdfDropArea').className = 'pdf-upload-area has-file';
    };
    reader.readAsDataURL(file);
  }

  function saveTaskDetail() {
    const t     = APP.getTaskById(taskDetailId);
    if (!t) return;
    const updates = {};

    // Status update
    const statusSel = document.getElementById('tdStatusSel');
    if (statusSel) updates.status = statusSel.value;

    // PDF
    if (pendingPdfData) { updates.pdfData = pendingPdfData; updates.pdfName = pendingPdfName; }

    // Completion data (when moving to Done as assignee)
    const compSection = document.getElementById('tdCompletionSection');
    if (compSection.style.display !== 'none') {
      const type = document.getElementById('cdType').value;
      if (updates.status === 'Done' || t.status === 'Done') {
        if (type) {
          updates.completionData = {
            type,
            rcc:     type === 'civil'       ? document.getElementById('cdRcc').value.trim()     : null,
            tonnage: type === 'structural'  ? document.getElementById('cdTonnage').value.trim() : null
          };
        }
      }
    }

    APP.updateTask(taskDetailId, updates);
    closeTaskDetailModal();
    renderTaskStats();
    renderTasks();
  }

  function closeTaskDetailModal() {
    taskDetailId = null; pendingPdfData = null; pendingPdfName = null;
    document.getElementById('taskDetailModal').classList.remove('open');
    document.getElementById('pdfFileInput').value = '';
  }

  // â”€â”€ Task Create/Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // L (HOD) and L1 (Manager) can pick any task due date.
  // Everyone else is capped at the project due date.
  function applyTaskDueDateMax() {
    const input = document.getElementById('tDueDate');
    const canOverride = currentUser.level === 'L' || currentUser.level === 'L0' || currentUser.level === 'L1';
    if (!canOverride && project && project.dueDate) {
      input.max = project.dueDate.split('T')[0];
    } else {
      input.removeAttribute('max');
    }
  }

  function openNewTaskModal() {
    document.getElementById('taskModalTitle').textContent = 'Add Task';
    document.getElementById('tTitle').value = '';
    document.getElementById('tDesc').value  = '';
    document.getElementById('tPriority').value = 'Medium';
    document.getElementById('tDueDate').value  = '';
    document.getElementById('editTaskId').value = '';
    document.getElementById('tSelfAssign').checked = false;
    applyTaskDueDateMax();
    populateAssigneeCheckboxes([]);
    document.getElementById('taskModal').classList.add('open');
  }

  function openEditTask(taskId) {
    const t = APP.getTaskById(taskId);
    if (!t) return;
    document.getElementById('taskModalTitle').textContent = 'Edit Task';
    document.getElementById('tTitle').value    = t.title;
    document.getElementById('tDesc').value     = t.description || '';
    document.getElementById('tPriority').value = t.priority;
    document.getElementById('tDueDate').value  = t.dueDate ? t.dueDate.split('T')[0] : '';
    document.getElementById('editTaskId').value = taskId;
    const assigneeIds = APP.getTaskAssigneeIds(t);
    document.getElementById('tSelfAssign').checked = assigneeIds.includes(currentUser.id);
    applyTaskDueDateMax();
    populateAssigneeCheckboxes(assigneeIds);
    document.getElementById('taskModal').classList.add('open');
  }

  function populateAssigneeCheckboxes(selectedIds) {
    const users = APP.getAssignableUsers(currentUser);
    const list  = document.getElementById('tAssigneeList');
    if (users.length === 0) {
      list.innerHTML = '<p style="font-size:12px;color:var(--text-muted);padding:8px;">No team members to assign (below your level in your group).</p>';
      return;
    }
    list.innerHTML = users.map(u => `
      <div class="assignee-check-item">
        <input type="checkbox" id="ac_${u.id}" value="${u.id}" ${selectedIds.includes(u.id) ? 'checked' : ''} style="width:16px;height:16px;accent-color:var(--purple);flex-shrink:0;">
        <label for="ac_${u.id}" style="font-size:13px;">
          <strong>${APP.escapeHtml(u.name)}</strong>
          <span style="color:var(--text-muted);"> â€” ${APP.escapeHtml(u.designation)}</span>
          ${u.group ? `<span style="font-size:10px;color:var(--purple-light);"> (${u.group})</span>` : ''}
        </label>
      </div>`).join('');
  }

  function toggleSelfAssign() {
    // Just a visual toggle â€” actual collection happens on save
  }

  function closeTaskModal() { document.getElementById('taskModal').classList.remove('open'); }

  function saveTask() {
    const title    = document.getElementById('tTitle').value.trim();
    const desc     = document.getElementById('tDesc').value.trim();
    const priority = document.getElementById('tPriority').value;
    const dueDate  = document.getElementById('tDueDate').value;
    const editId   = document.getElementById('editTaskId').value;

    if (!title) return APP.showAlert('taskModalAlert', 'Task title is required.');

    // Enforce due date cap for non-L/L1 users
    const canOverrideDue = currentUser.level === 'L' || currentUser.level === 'L0' || currentUser.level === 'L1';
    if (!canOverrideDue && dueDate && project && project.dueDate) {
      if (dueDate > project.dueDate.split('T')[0]) {
        return APP.showAlert('taskModalAlert', `Due date cannot be after the project due date (${APP.formatDate(project.dueDate)}).`);
      }
    }

    // Collect assignee IDs from checkboxes + self-assign
    const checked = [...document.querySelectorAll('#tAssigneeList input[type=checkbox]:checked')].map(cb => cb.value);
    if (document.getElementById('tSelfAssign').checked && !checked.includes(currentUser.id)) {
      checked.unshift(currentUser.id);
    }

    if (editId) {
      APP.updateTask(editId, { title, description: desc, priority, dueDate: dueDate || null, assigneeIds: checked, assigneeId: checked[0] || null });
    } else {
      APP.createTask({ projectId, title, description: desc, priority, dueDate: dueDate || null, assigneeIds: checked, assigneeId: checked[0] || null }, currentUser.id);
    }
    closeTaskModal();
    renderTaskStats();
    renderTasks();
  }

  // â”€â”€ Edit Project Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openEditProjectModal() {
    document.getElementById('epTitle').value    = project.title;
    document.getElementById('epDesc').value     = project.description || '';
    document.getElementById('epPriority').value = project.priority;
    document.getElementById('epStatus').value   = project.status || 'Not Started';
    document.getElementById('epDueDate').value  = project.dueDate ? project.dueDate.split('T')[0] : '';
    document.getElementById('editProjectModal').classList.add('open');
  }
  function closeEditProjectModal() { document.getElementById('editProjectModal').classList.remove('open'); }

  function saveEditProject() {
    const title    = document.getElementById('epTitle').value.trim();
    const desc     = document.getElementById('epDesc').value.trim();
    const priority = document.getElementById('epPriority').value;
    const status   = document.getElementById('epStatus').value;
    const dueDate  = document.getElementById('epDueDate').value;
    if (!title) return APP.showAlert('editProjAlert', 'Project title is required.');
    project = APP.updateProject(projectId, { title, description: desc, priority, status, dueDate });
    document.getElementById('topbarTitle').textContent = project.title;
    closeEditProjectModal();
    renderProjectHeader();
    renderTaskStats();
    renderTasks();
  }

  // â”€â”€ Delete Task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openDeleteTask(id, name) {
    deleteTaskTarget = id;
    document.getElementById('deleteTaskName').textContent = name;
    document.getElementById('deleteTaskModal').classList.add('open');
  }
  function closeDeleteTaskModal() { deleteTaskTarget = null; document.getElementById('deleteTaskModal').classList.remove('open'); }
  function confirmDeleteTask() {
    if (deleteTaskTarget) { APP.deleteTask(deleteTaskTarget); closeDeleteTaskModal(); renderTaskStats(); renderTasks(); }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ CONCURRENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderConcurrences() {
    const list      = APP.getProjectConcurrences(projectId);
    const container = document.getElementById('concurrenceList');
    if (list.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><h3>No concurrences yet</h3><p>${APP.canCreateConcurrence(currentUser) ? 'Create one for drawings ready for sign-off.' : 'No concurrences created for this project yet.'}</p></div>`;
      return;
    }
    container.innerHTML = list.map(cl => renderConcurrence(cl)).join('');
  }

  function renderConcurrence(cl) {
    const allSigned    = APP.concurrenceAllSigned(cl);
    const canHodSign   = APP.isAdmin(currentUser) && allSigned && !cl.hodSignOff.signed;
    const canSend      = APP.isAdmin(currentUser) && cl.hodSignOff.signed && !cl.sentToClient;
    const canDelete    = APP.canCreateConcurrence(currentUser) && !cl.sentToClient;

    const reviewersHtml = cl.reviewers.map(r => `
      <div class="reviewer-row ${r.signed ? 'signed' : ''}">
        <span style="font-size:18px;">${r.signed ? 'âœ…' : 'â¬œ'}</span>
        <div style="flex:1;">
          <div class="rv-name">${APP.escapeHtml(r.name)}</div>
          <div class="rv-desig">${APP.escapeHtml(r.designation)}</div>
        </div>
        ${r.signed
          ? `<div class="rv-date">Signed ${APP.formatDate(r.signedAt)}</div>`
          : (r.userId === currentUser.id
            ? `<button class="btn btn-green btn-sm" onclick="signConcurrence('${cl.id}')">Sign</button>`
            : '<span style="font-size:11px;color:var(--text-muted);">Pending</span>'
          )
        }
      </div>`).join('');

    return `
      <div class="concurrence-card ${cl.sentToClient ? 'sent' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
          <div>
            <div class="concurrence-title">ğŸ“„ ${APP.escapeHtml(cl.drawingTitle)}</div>
            ${cl.description ? `<div class="concurrence-desc">${APP.escapeHtml(cl.description)}</div>` : ''}
            <div style="font-size:11px;color:var(--text-muted);">Created by ${APP.getUserName(cl.createdBy)} Â· ${APP.formatDate(cl.createdAt)}</div>
          </div>
          ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="deleteConcurrence('${cl.id}')">ğŸ—‘ï¸</button>` : ''}
        </div>
        <div style="margin:14px 0 8px;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">
          Reviewers (${cl.reviewers.filter(r=>r.signed).length}/${cl.reviewers.length} signed)
        </div>
        ${reviewersHtml}
        <div class="hod-signoff">
          <div style="font-size:12px;font-weight:600;color:var(--purple-dark);margin-bottom:6px;">HOD Final Sign-off</div>
          ${cl.hodSignOff.signed
            ? `<div style="color:var(--green-dark);font-size:13px;">âœ… Signed by ${APP.getUserName(cl.hodSignOff.signedBy)} on ${APP.formatDate(cl.hodSignOff.signedAt)}</div>`
            : (canHodSign
              ? `<button class="btn btn-primary btn-sm" onclick="hodSignConcurrence('${cl.id}')">âœï¸ Sign &amp; Approve</button>
                 <span style="font-size:11px;color:var(--green-dark);margin-left:8px;">All reviewers have signed</span>`
              : `<span style="font-size:12px;color:var(--text-muted);">${allSigned ? 'Ready for HOD sign-off' : `Waiting for ${cl.reviewers.filter(r=>!r.signed).length} reviewer(s)`}</span>`
            )
          }
        </div>
        ${cl.sentToClient
          ? `<div class="sent-banner">âœˆï¸ Sent to client on ${APP.formatDate(cl.sentAt)}</div>`
          : (canSend ? `<button class="btn btn-green btn-sm" style="margin-top:10px;" onclick="sendToClient('${cl.id}')">âœˆï¸ Mark as Sent to Client</button>` : '')
        }
      </div>`;
  }

  function signConcurrence(id)     { APP.signConcurrence(id, currentUser.id); renderConcurrences(); renderTaskStats(); renderTasks(); }
  function hodSignConcurrence(id)  { APP.hodSignConcurrence(id, currentUser.id); renderConcurrences(); }
  function sendToClient(id)        { if (confirm('Mark as sent to client?')) { APP.markSentToClient(id); renderConcurrences(); } }
  function deleteConcurrence(id)   { if (confirm('Delete this concurrence and its sign-off tasks?')) { APP.deleteConcurrence(id); renderConcurrences(); renderTaskStats(); renderTasks(); } }

  function openNewConcurrenceModal() {
    document.getElementById('clTitle').value = '';
    document.getElementById('clDesc').value  = '';
    populateConcurrenceReviewerList([]);
    document.getElementById('concurrenceModal').classList.add('open');
  }
  function closeConcurrenceModal() { document.getElementById('concurrenceModal').classList.remove('open'); }

  function populateConcurrenceReviewerList(preChecked) {
    const users = APP.getUsers().filter(u => u.id !== currentUser.id);
    document.getElementById('reviewerCheckboxes').innerHTML = users.length === 0
      ? '<p style="font-size:12px;color:var(--text-muted);">No other users yet.</p>'
      : users.map(u => `
          <div class="assignee-check-item">
            <input type="checkbox" id="rv_${u.id}" value="${u.id}" data-name="${APP.escapeHtml(u.name)}" data-desig="${APP.escapeHtml(u.designation)}" ${preChecked.includes(u.id)?'checked':''} style="width:16px;height:16px;accent-color:var(--purple);flex-shrink:0;">
            <label for="rv_${u.id}" style="font-size:13px;">
              <strong>${APP.escapeHtml(u.name)}</strong>
              <span style="color:var(--text-muted);"> â€” ${APP.escapeHtml(u.designation)}</span>
            </label>
          </div>`).join('');
  }

  function autoPopulateReviewers() {
    const participants = APP.getProjectParticipants(projectId);
    const ids = participants.map(u => u.id);
    populateConcurrenceReviewerList(ids);
    if (ids.length === 0) APP.showAlert('clAlert', 'No task participants found yet. Add tasks first.');
  }

  function saveConcurrence() {
    const title   = document.getElementById('clTitle').value.trim();
    const desc    = document.getElementById('clDesc').value.trim();
    if (!title) return APP.showAlert('clAlert', 'Drawing title is required.');
    const checked = [...document.querySelectorAll('#reviewerCheckboxes input[type=checkbox]:checked')];
    if (checked.length === 0) return APP.showAlert('clAlert', 'Select at least one reviewer.');
    const reviewers = checked.map(cb => ({
      userId: cb.value, name: cb.dataset.name, designation: cb.dataset.desig,
      signed: false, signedAt: null
    }));
    APP.createConcurrence({ projectId, drawingTitle: title, description: desc, reviewers }, currentUser.id);
    closeConcurrenceModal();
    renderConcurrences();
    renderTaskStats();
    renderTasks();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ SUBPROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSubprojects() {
    const subs      = APP.getSubprojects(projectId);
    const container = document.getElementById('subprojectList');
    if (subs.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“</div><h3>No subprojects yet</h3><p>Break this project into smaller deliverables.</p></div>`;
      return;
    }
    const allTasks = APP.getTasks();
    container.innerHTML = subs.map(s => {
      const tasks = allTasks.filter(t => t.projectId === s.id);
      const done  = tasks.filter(t => t.status === 'Done').length;
      const pct   = tasks.length ? Math.round((done / tasks.length) * 100) : 0;
      const statusClass = (s.status||'Not Started').replace(/\s+/g,'').toLowerCase();
      return `
        <div class="sub-card" onclick="window.location.href='project.html?id=${s.id}'">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <div style="font-weight:600;font-size:14px;color:var(--text);">${APP.escapeHtml(s.title)}</div>
              ${s.description ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px;">${APP.escapeHtml(s.description)}</div>` : ''}
            </div>
            <span class="badge badge-${statusClass}" style="flex-shrink:0;">${s.status||'Not Started'}</span>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">
            ğŸ“… Due: ${APP.formatDate(s.dueDate)} &nbsp;Â·&nbsp; ğŸ“‹ ${done}/${tasks.length} tasks &nbsp;Â·&nbsp; ${pct}% done
          </div>
          <div class="progress-bar" style="margin-top:6px;height:4px;">
            <div class="progress-fill" style="width:${pct}%;background:${pct===100?'var(--green)':'var(--purple)'};"></div>
          </div>
        </div>`;
    }).join('');
  }

  function openNewSubprojectModal() {
    document.getElementById('spTitle').value = '';
    document.getElementById('spDesc').value  = '';
    document.getElementById('spPriority').value = 'Medium';
    document.getElementById('spDueDate').value  = '';
    document.getElementById('subprojectModal').classList.add('open');
  }
  function closeSubprojectModal() { document.getElementById('subprojectModal').classList.remove('open'); }

  function saveSubproject() {
    const title    = document.getElementById('spTitle').value.trim();
    const desc     = document.getElementById('spDesc').value.trim();
    const priority = document.getElementById('spPriority').value;
    const dueDate  = document.getElementById('spDueDate').value;
    if (!title) return APP.showAlert('spAlert', 'Subproject title is required.');
    APP.createProject({ title, description: desc, priority, dueDate: dueDate || null, parentProjectId: projectId }, currentUser.id);
    closeSubprojectModal();
    renderSubprojects();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderNotes() {
    const notes     = APP.getProjectNotes(projectId);
    const container = document.getElementById('notesList');
    if (notes.length === 0) {
      container.innerHTML = '<p style="font-size:13px;color:var(--text-muted);">No notes yet. Be the first to add one.</p>';
      return;
    }
    container.innerHTML = notes.map(n => `
      <div class="note-card">
        <div class="note-meta">
          ${APP.escapeHtml(APP.getUserName(n.createdBy))} Â· ${APP.formatDateTime(n.createdAt)}
          ${(n.createdBy === currentUser.id || APP.isAdmin(currentUser))
            ? `<button class="btn btn-ghost btn-sm" style="float:right;font-size:10px;padding:1px 6px;" onclick="deleteNote('${n.id}')">ğŸ—‘ï¸</button>` : ''}
        </div>
        <div class="note-text">${APP.escapeHtml(n.text)}</div>
      </div>`).join('');
  }

  function addNote() {
    const text = document.getElementById('newNoteText').value.trim();
    if (!text) return;
    APP.addNote(projectId, text, currentUser.id);
    document.getElementById('newNoteText').value = '';
    renderNotes();
  }

  function deleteNote(id) {
    if (confirm('Delete this note?')) { APP.deleteNote(id); renderNotes(); }
  }

  // â”€â”€ Close modals on overlay click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ['taskModal','taskDetailModal','editProjectModal','deleteTaskModal','concurrenceModal','subprojectModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });
  });

  // Refresh on page visibility
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      renderTaskStats(); renderTasks();
      if (currentTab === 'concurrence') renderConcurrences();
      if (currentTab === 'subprojects') renderSubprojects();
      if (currentTab === 'notes')       renderNotes();
    }
  });

  init();
</script>
</body>
</html>
